{% extends "layout.html" %}

{% block content %}
<script>
	localStorage.setItem('page', 'sharing');

	// 読み込み時
	window.addEventListener('load', () => {
		const loadingElement = document.getElementById('loading');
		// ボタン要素リスト
		let btns = document.querySelectorAll('button.btn');
		// MutationObserver: 変化判定用要素（テーブル）
		const trig = document.querySelector('table#list');
		// MutationObserver
		const observer = new MutationObserver((mutations) => {
			// ボタン要素リスト再取得
			btns = document.querySelectorAll('button.btn');
			// 各ボタンにイベントリスナ（クリック）再設定
			for (btn of btns) {
				btn.removeEventListener('click', btn_click)
				btn.addEventListener('click', btn_click)
			}
		});

		// MutationObserver: オプション
		const config = {
			characterData: true,
			subtree: true,
			attributes: true,
			childList: true
		};

		// MutationObserver: 設置
		observer.observe(trig, config);

		// 各ボタンにイベントリスナ（クリック）初期設定
		for (btn of btns) {
			btn.addEventListener('click', btn_click)
		}

		// ボタンクリック時関数
		function btn_click(e) {
			// クリックボタン要素
			const clickelm = e.target;
			// クリックボタンID（data属性から取得）
			const id = clickelm.dataset.objectid;
			const guest = clickelm.dataset.guest;
			const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

			loadingElement.style.display = 'block';

			// APIコール
			fetch('/ajax/deleteshare', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrfToken
				},
				body: JSON.stringify({ id: id, guest: guest }),
			})
				// レスポンス受信
				.then(response => {
					// レスポンス異常
					if (!response.ok) {
						loadingElement.style.display = 'none';
						showToast(`${response.status}:${response.statusText}`, 'error');
					}
					// レスポンス正常
					return response.json();
				})
				// レスポンスデータ取得
				.then(data => {
					loadingElement.style.display = 'none';
					showToast(`${data.message}`, 'success');
					location.reload(); // レスポンスが正常ならリロード
				})
				// エラーハンドリング
				.catch((error) => {
					loadingElement.style.display = 'none';
					showToast(`${error}`, 'error');
				});
		}

		// トースト表示する関数
		function showToast(text, type) {
			// 新しいトースト要素の作成
			const newToast = document.createElement("div");
			newToast.classList.add("toast", "align-items-center", "border-0");
			newToast.role = "alert";
			newToast.ariaLive = "assertive";
			newToast.ariaAtomic = "true";

			// トーストの背景色を設定
			newToast.classList.add(type === 'success' ? 'text-bg-primary' :
				type === 'error' ? 'text-bg-danger' :
					'text-bg-warning');

			// トーストの内容を設定
			newToast.innerHTML = `
					<div class="d-flex">
							<div class="toast-body">${text}</div>
							<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
					</div>
			`;

			// トーストコンテナにトーストを追加
			const toastContainer = document.querySelector('.toast-container');
			toastContainer.appendChild(newToast);

			// トーストを表示
			const toastInstance = new bootstrap.Toast(newToast);
			toastInstance.show();

			// トーストが閉じたらDOMから削除
			newToast.addEventListener('hidden.bs.toast', function () {
				newToast.remove();
			});
		}
	});
</script>

<div class="container-fluid p-0">
	<h1 class="h3 mb-3">共有中の議事録</h1>
	<div class="row">
		<div class="col-12 col-md-12 col-xxl-12 d-flex">
			<div class="card flex-fill w-100">
				<div class="card-header">
					<h5 class="card-title mb-0">一覧</h5>
				</div>
				<div class="card-body d-flex">
					<table id="list" class="table table-striped">
						<thead class="thead-dark">
							<tr>
								<th data-sortable="false">サムネイル</th>
								<th>ファイル名</th>
								<th>共有先ユーザー</th>
								<th data-sortable="false" colspan="2"></th>
							</tr>
						</thead>
						<tbody>
							{% for object in objects %}
							<tr>
								<td>
									{% if object.thumbnailLink %}
									{{ object.thumbnailLink }}
									{% else %}
									{{ url_for('static', filename='loading.png') }}
									{% endif %}
								</td>
								<td><a href="./video/{{ object.video_id }}">{{ object.title }}</a></td>
								<td>{{ object.guest_email }}</td>
								<td><button data-objectid="{{ object.video_id }}" data-guest="{{ object.guest_email }}" class="delete-action btn btn-outline-danger btn-sm" type="submit">共有解除</button></td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
	<div id="Toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
		<div class="d-flex">
			<div class="toast-body" id="Toastcontent">
			</div>
			<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
		</div>
	</div>
</div>

<!-- ローディングアニメーション -->
<div id="loading" class="loading" style="display: none;">
	<div class="spinner"></div>
</div>

<link href="https://cdn.jsdelivr.net/npm/simple-datatables@6.0/dist/style.css" rel="stylesheet" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@6.0" type="text/javascript"></script>
<script>
	new simpleDatatables.DataTable("#list", {
		fixedColumns: true,
		perPage: 20,
		perPageSelect: false,
		labels: {
			placeholder: "検索...",
			searchTitle: "Search within table",
			noRows: "データがありません。",
			info: "{start} - {end} 件 / {rows} 件",
			noResults: "該当するデータがありません。",
		},
		columns: [
			{
				select: 0, // 画像カラム
				type: "string",
				render: function (data, td) {
					const dec = decodeURIComponent(data);
					const trim = dec.replace(/^\s+|\s+$/g, '').replace(/\s+/g, ' ');

					return `<img src="${trim}" height="50px">`;
				}
			}
		]
	})
</script>
{%- endblock %}